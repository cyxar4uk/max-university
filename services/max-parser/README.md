# Парсер каналов MAX

Парсер для мониторинга каналов мессенджера MAX и сохранения новостных постов в MongoDB.

## Описание

Этот парсер работает аналогично Telegram-парсеру (`services/cold-news`), но использует API мессенджера MAX через библиотеку PyMax.

### Основные возможности

- ✅ Мониторинг каналов MAX в реальном времени
- ✅ Классификация постов через GigaChat API
- ✅ Сохранение в MongoDB (та же коллекция `news_posts`, что и Telegram-парсер)
- ✅ Автоматическая фильтрация по темам
- ✅ Очистка старых постов

## Установка

### 1. Установка зависимостей

```bash
cd services/max-parser
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 2. Настройка переменных окружения

Скопируйте `.env.example` в `.env` и заполните:

```bash
cp .env.example .env
```

Обязательные переменные:
- `MAX_PHONE` - номер телефона для авторизации в MAX
- `MONGOdb` - строка подключения к MongoDB
- `GIGACHAT_*` - ключи для GigaChat API

### 3. Первый запуск

При первом запуске потребуется авторизация:

- Если `MAX_USE_SOCKET=true` (по умолчанию): потребуется ввести код подтверждения из SMS
- Если `MAX_USE_SOCKET=false`: потребуется отсканировать QR-код из приложения MAX

```bash
python parser.py
```

После успешной авторизации сессия сохранится в `work_dir` (по умолчанию `./cache`).

## Использование

### Запуск парсера

```bash
python parser.py
```

Парсер будет:
1. Подключаться к MAX
2. Загружать список всех каналов, на которые подписан аккаунт
3. Мониторить новые сообщения из каналов
4. Классифицировать посты через GigaChat
5. Сохранять посты в MongoDB

### Структура проекта

```
max-parser/
├── parser.py          # Основной парсер
├── models.py          # Работа с MongoDB
├── classifier.py      # Классификация через GigaChat
├── channels_config.py # Конфигурация каналов
├── requirements.txt   # Зависимости Python
├── .env.example       # Пример переменных окружения
└── README.md          # Документация
```

## Интеграция с существующей системой

Парсер использует:
- **Ту же MongoDB коллекцию** `news_posts` - посты сохраняются в том же формате
- **Ту же логику классификации** GigaChat - идентичные промпты и обработка
- **Те же темы** - получает список тем из БД пользователей

Это означает, что посты из MAX и Telegram будут храниться вместе и отображаться в одной ленте.

## Отличия от Telegram-парсера

| Аспект | Telegram-парсер | MAX-парсер |
|--------|----------------|------------|
| Язык | Node.js | Python |
| Библиотека | TelegramClient (MTProto) | PyMax (WebSocket) |
| Авторизация | Сессия (StringSession) | Номер телефона / QR-код |
| Мониторинг | EventHandler | @on_message декоратор |
| Фильтрация | По ID каналов | По типу чата (ChatType.CHANNEL) |

## Логирование

Парсер выводит логи в консоль с уровнями:
- `INFO` - основная информация о работе
- `DEBUG` - детальная информация для отладки
- `WARNING` - предупреждения
- `ERROR` - ошибки

## Решение проблем

### Ошибка авторизации

Если возникают проблемы с авторизацией:
1. Проверьте правильность номера телефона (`MAX_PHONE`)
2. Убедитесь, что номер телефона зарегистрирован в MAX
3. Попробуйте удалить папку `cache` и авторизоваться заново

### Нет каналов для мониторинга

Если парсер не находит каналов:
1. Убедитесь, что аккаунт подписан на каналы в MAX
2. Проверьте, что каналы имеют тип `CHANNEL` (не группа)
3. Попробуйте перезапустить парсер

### Ошибки MongoDB

Если возникают проблемы с MongoDB:
1. Проверьте строку подключения `MONGOdb`
2. Убедитесь, что MongoDB доступна
3. Проверьте права доступа к базе данных

## Разработка

### Добавление новых функций

Основные файлы для модификации:
- `parser.py` - логика мониторинга и обработки сообщений
- `classifier.py` - логика классификации через GigaChat
- `models.py` - работа с базой данных

### Тестирование

Для тестирования можно использовать тестовый аккаунт MAX и небольшой список каналов.

## Лицензия

Проект использует ту же лицензию, что и основной репозиторий.
