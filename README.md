# Цифровой университет MAX

Платформа-конструктор для создания цифровых пространств вузов в мессенджере MAX. Решение позволяет администраторам вузов настраивать блочную структуру приложения для разных ролей пользователей (студенты, абитуриенты, сотрудники, администраторы).

## Концепция проекта

Платформа предоставляет универсальный конструктор для вузов:
- Администраторы вузов настраивают блочную структуру приложения через удобный интерфейс
- Каждая роль (студент, абитуриент, сотрудник, администратор) видит только доступные ей блоки
- Администратор может создавать разделы, добавлять/удалять блоки, менять их порядок (drag & drop)
- Настройка цветов хедера персонально для каждой роли
- Блоки включают: расписание, учебные материалы, услуги, новости, аналитику и др.
- Решение масштабируемо и универсально для любых вузов
- Система кодов приглашения для регистрации пользователей
- Возможность создания кастомных виджетов с модерацией

## Архитектура решения

### Общая структура
- **Frontend**: React + Vite (собственные стили, без зависимости от сторонних UI-библиотек)
- **Backend**: FastAPI (Python) с асинхронной обработкой запросов
- **Database**: SQLite (файлы .db в папке data/) с поддержкой нескольких баз
- **State Management**: Redux Toolkit для управления состоянием приложения
- **Bridge**: MAX Bridge API для интеграции с мессенджером MAX
- **Bot**: MAX Bot API для чат-бота

### Масштабируемость
Архитектура спроектирована с учетом масштабирования:
- Микросервисная архитектура позволяет разделить компоненты
- SQLite легко мигрируется на PostgreSQL для высоких нагрузок
- Redis можно добавить для кеширования и очередей
- Docker Compose поддерживает горизонтальное масштабирование
- API построено на FastAPI с поддержкой async/await
- Фронтенд легко интегрируется с CDN для быстрой загрузки

## Технические требования

### Минимальные требования для запуска
- Node.js версии 18 или выше
- Python версии 3.9 или выше
- npm или yarn
- 2 GB RAM (рекомендуется 4 GB)
- 1 GB свободного места на диске

### Опционально
- Docker версии 20.10 или выше
- Docker Compose версии 2.0 или выше

### Поддерживаемые платформы
- Windows 10/11
- macOS 10.15 или выше
- Linux (Ubuntu 20.04+, Debian 10+, CentOS 8+)

## Ключевые функции и пользовательские сценарии

### Для студентов
- **Расписание**: просмотр расписания занятий на текущий день с информацией об аудитории и типе занятия
- **Учебные материалы**: доступ к курсам с отслеживанием прогресса обучения
- **Услуги**: заказ справок и документов (справка с места учебы, подача заявления, оплата услуг, заказ гостевого пропуска)
- **Внеучебная жизнь**: просмотр и регистрация на события, мероприятия
- **Новости**: актуальная лента новостей университета с каруселью
- **Цифровой пропуск**: QR-код с таймером обновления для прохода в кампус

### Для абитуриентов
- **Новости**: информация о жизни университета
- **Поступление**: информация о программах и подача документов
- **Оплата**: оплата вступительных взносов

### Для сотрудников
- **Расписание**: рабочий график и совещания
- **Услуги**: подача заявок и запросов
- **Новости**: внутренние новости и объявления

### Для администраторов университета
- **Аналитика**: статистика по студентам, преподавателям, событиям, средний GPA
- **Настройки интерфейса**: полная кастомизация структуры для каждой роли
  - Создание и редактирование разделов
  - Добавление/удаление блоков
  - Drag & drop для изменения порядка
  - Настройка цветов хедера
  - Использование готовых шаблонов
- **Управление кодами приглашения**:
  - Генерация кодов по ролям
  - Импорт студентов из CSV с автоматической генерацией кодов
  - Экспорт таблицы с кодами
- **Кастомные блоки**: отправка собственных виджетов на модерацию

### Для суперадминов приложения
- **Управление университетами**: создание новых университетов в системе
- **Назначение администраторов**: управление правами доступа
- **Модерация кастомных блоков**: проверка и одобрение виджетов от администраторов вузов
- **Просмотр статистики**: общая статистика по всем университетам

## Быстрый старт

### Вариант 1: Локальный запуск

#### 1. Установка зависимостей фронтенда

```bash
npm install
```

#### 2. Установка зависимостей бэкенда

```bash
# Создание виртуального окружения
python -m venv venv

# Активация виртуального окружения
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt
```

#### 3. Инициализация базы данных

База данных создается автоматически при первом запуске бэкенда. Файлы .db будут созданы в папке data/:
- data/users.db - пользователи и суперадмины
- data/universities.db - университеты и коды приглашения
- data/config.db - конфигурации разделов, блоков и кастомные виджеты

#### 4. Запуск бэкенда

В одном терминале:

```bash
# Активация виртуального окружения (если не активировано)
venv\Scripts\activate  # Windows
# или
source venv/bin/activate  # Linux/Mac

# Запуск сервера
python main.py
```

Бэкенд будет доступен по адресу: http://localhost:8000

API документация: http://localhost:8000/docs

#### 5. Запуск фронтенда

В другом терминале:

```bash
npm run dev
```

Фронтенд будет доступен по адресу: http://localhost:3000

### Вариант 2: Запуск через Docker

```bash
# Запуск всех сервисов
docker-compose up --build

# Или в фоновом режиме
docker-compose up -d --build

# Остановка
docker-compose down
```

После запуска:
- Фронтенд: http://localhost
- Бэкенд: http://localhost:8000
- API документация: http://localhost:8000/docs

## Важное примечание о запуске в MAX

**Статус интеграции с MAX**: В процессе разработки мы полностью интегрировали MAX Bridge API и MAX Bot API в наше решение. Однако, на момент подачи заявки мы не получили ответа на анкету для использования токена бота в production окружении MAX.

**Что реализовано**:
- Полная интеграция MAX Bridge для работы внутри мессенджера
- MAX Bot API с вебхуками и inline-кнопками
- Обработка всех событий от бота (команды, callback query)
- Передача параметров роли через start_param
- Haptic feedback и другие нативные возможности MAX

**Как протестировать**:
- Приложение полностью функционально в браузере по адресу: https://cyxar4uk.github.io/max-university/
- Весь код для работы с MAX Bridge находится в useMAXBridge.v2.js
- Мок MAX Bridge инициализируется автоматически в index.html для браузерного тестирования
- После получения токена достаточно обновить MAX_BOT_TOKEN в main.py и настроить вебхук

**Токен бота**: f9LHodD0cOI5MJfQ6eqCiVzCVUt8Va__S2Nzwvj06nK6_VfYt4Ra9Sp04TSWBpi5vi_XOuNQ9MNBrHU6hsIu

## Работа на GitHub Pages

### Что работает на GitHub Pages

Фронтенд полностью работает на GitHub Pages:
- Все страницы приложения
- Навигация между разделами
- Система кодов приглашения
- Все функции интерфейса
- Мок-данные для демонстрации
- Мок-режим с уведомлением при недоступности бэкенда

### Ограничения GitHub Pages

GitHub Pages - это статический хостинг, поэтому:
- Бэкенд (FastAPI) не работает на GitHub Pages
- База данных SQLite не доступна на GitHub Pages
- Но приложение использует мок-данные как fallback, поэтому все работает

### Как это работает

1. Приложение пытается обратиться к бэкенду
2. Если бэкенд недоступен (как на GitHub Pages), используются мок-данные
3. Показывается временное уведомление о работе в демо-режиме
4. Все функции работают в режиме демонстрации

### Для полноценной работы с бэкендом

Для работы с реальной базой данных и бэкендом нужно:
- Развернуть бэкенд на отдельном хостинге (Heroku, Railway, Render и т.д.)
- Обновить VITE_API_URL в настройках GitHub Actions

Текущая ссылка: https://cyxar4uk.github.io/max-university/

## Тестирование разных ролей

### Система кодов приглашения

По умолчанию при открытии приложения запрашивается код приглашения:
- Тестовый код: TEST-CODE-123 (роль: студент)
- После использования кода смена роли недоступна (имитация реальной работы)

### Для тестирования с параметрами URL

Локально (http://localhost:3000):
- Студент: http://localhost:3000/#/?role=student
- Абитуриент: http://localhost:3000/#/?role=applicant
- Сотрудник: http://localhost:3000/#/?role=employee
- Администратор: http://localhost:3000/#/?role=admin

GitHub Pages (https://cyxar4uk.github.io/max-university/):
- Студент: https://cyxar4uk.github.io/max-university/#/?role=student
- Абитуриент: https://cyxar4uk.github.io/max-university/#/?role=applicant
- Сотрудник: https://cyxar4uk.github.io/max-university/#/?role=employee
- Администратор: https://cyxar4uk.github.io/max-university/#/?role=admin

### Тестовые пользователи

Приложение включает 4 предустановленных тестовых пользователя:
1. Иван Петров (Студент) - ID: 10001
2. Мария Иванова (Абитуриент) - ID: 10002
3. Петр Сидоров (Сотрудник) - ID: 10003
4. Анна Смирнова (Администратор) - ID: 10004

Переключатель пользователей доступен в профиле (только для пользователей без кода приглашения).

### Тестирование суперадмина

Для доступа к панели суперадмина:
1. Используйте URL с параметром role=admin
2. В панели администратора будет доступна навигация на /superadmin
3. Тестовый суперадмин создается автоматически с ID: 1

## Структура проекта

```
max-university/
├── main.py                      # FastAPI бэкенд сервер с MAX Bot API
├── database.py                  # Модуль работы с SQLite базами данных
├── data/                        # Папка с файлами .db (создается автоматически)
│   ├── users.db                # База данных пользователей и суперадминов
│   ├── universities.db         # База данных университетов и кодов приглашения
│   └── config.db               # База данных конфигураций и кастомных блоков
├── App.v2.jsx                   # Главный компонент React с роутингом
├── HomePage.v2.jsx              # Главная страница с виджетами
├── WelcomePage.v2.jsx           # Страница входа с кодом приглашения
├── ProfilePage.v2.jsx           # Страница профиля с переключателем пользователей
├── AdminPage.v2.jsx             # Панель администратора университета
├── AdminConfigPage.v2.jsx      # Настройка интерфейса (разделы, блоки, drag&drop)
├── pages/
│   ├── CustomBlocksPage.v2.jsx # Отправка кастомных виджетов на модерацию
│   ├── InvitationCodesPage.v2.jsx # Управление кодами приглашения
│   └── SuperAdminPage.v2.jsx   # Панель суперадмина
├── Widgets/                     # Виджеты для блоков
│   ├── BlockWidget.jsx         # Роутер виджетов
│   ├── ScheduleWidget.jsx      # Виджет расписания
│   ├── NewsWidget.jsx          # Виджет новостей с каруселью
│   ├── ServicesWidget.jsx      # Виджет услуг
│   ├── CoursesWidget.jsx       # Виджет курсов
│   ├── EventsWidget.jsx        # Виджет событий
│   ├── PaymentWidget.jsx       # Виджет оплаты
│   ├── AdmissionWidget.jsx     # Виджет поступления
│   ├── AnalyticsWidget.jsx     # Виджет аналитики
│   └── DigitalPassWidget.jsx   # Цифровой пропуск с QR-кодом
├── components/
│   └── MockModeNotification.jsx # Уведомление о работе в мок-режиме
├── utils/
│   └── errorLogger.js          # Логирование ошибок для отладки
├── SchedulePage.v2.jsx          # Детальная страница расписания
├── CoursesPage.v2.jsx           # Детальная страница курсов
├── EventsPage.v2.jsx            # События
├── NewsPage.v2.jsx              # Новости
├── ServicesPage.v2.jsx          # Электронные услуги
├── PaymentPage.v2.jsx           # Оплата
├── AdmissionPage.v2.jsx         # Поступление
├── UserSwitcher.jsx             # Переключатель тестовых пользователей
├── mockUsers.js                 # Тестовые пользователи
├── useMAXBridge.v2.js           # Хук для работы с MAX Bridge
├── userSlice.js                 # Redux slice для пользователя
├── store.js                     # Redux store
├── api-service.js               # Сервис для работы с API и мок-режим
├── styles.css                   # Собственные стили без внешних библиотек
├── Dockerfile                   # Dockerfile для бэкенда
├── Dockerfile.frontend          # Dockerfile для фронтенда
├── docker-compose.yml           # Docker Compose конфигурация
├── package.json                 # Зависимости Node.js
├── requirements.txt             # Зависимости Python
├── vite.config.js               # Конфигурация Vite
├── index.html                   # Entry point с мок MAX Bridge
├── main.jsx                     # Инициализация React приложения
└── README.md                    # Этот файл
```

## API Endpoints

### Основные
- GET / - Информация о API
- GET /api/health - Проверка здоровья сервера

### Аутентификация
- POST /api/users/auth - Аутентификация пользователя через MAX Bridge
- PUT /api/users/role - Обновление роли пользователя

### Коды приглашения
- POST /api/invitation/use - Использовать код приглашения
- POST /api/admin/invitation-codes/generate - Сгенерировать коды (admin)
- GET /api/admin/invitation-codes - Получить список кодов (admin)
- POST /api/admin/invitation-codes/import-students - Импорт студентов с генерацией кодов

### Университеты
- GET /api/universities/{id} - Информация об университете
- GET /api/universities/{id}/blocks?role={role} - Конфигурация блоков для роли

### Контент
- GET /api/schedule?date={date} - Расписание пользователя
- GET /api/courses - Список курсов
- GET /api/events - Список событий
- POST /api/events/{id}/register - Регистрация на событие
- GET /api/news - Новости университета
- GET /api/statistics - Статистика университета

### Админ-панель университета
- GET /api/admin/config/{university_id}/{role} - Получить конфигурацию
- PUT /api/admin/sections/{section_id}/name - Обновить название раздела
- PUT /api/admin/config/{university_id}/{role}/header-color - Обновить цвет хедера
- POST /api/admin/blocks/reorder - Изменить порядок блоков
- POST /api/admin/sections/{section_id}/blocks - Добавить блок
- DELETE /api/admin/blocks/{block_id} - Удалить блок
- POST /api/admin/sections - Добавить раздел
- POST /api/admin/sections/reorder - Изменить порядок разделов
- DELETE /api/admin/sections/{section_id} - Удалить раздел
- GET /api/admin/templates - Получить шаблоны
- POST /api/admin/templates - Сохранить шаблон

### Кастомные блоки
- POST /api/admin/custom-blocks/submit - Отправить блок на модерацию
- GET /api/admin/custom-blocks/pending - Блоки на модерации (superadmin)
- POST /api/admin/custom-blocks/{block_id}/review - Одобрить/отклонить блок
- GET /api/admin/custom-blocks/approved - Одобренные блоки
- GET /api/admin/custom-blocks/standards - Стандарты разработки блоков

### Суперадмин
- GET /api/superadmin/universities - Список всех университетов
- POST /api/superadmin/universities - Создать университет
- POST /api/superadmin/universities/{id}/admin - Назначить администратора

### Bot Webhook
- POST /api/bot/webhook - Вебхук для получения обновлений от MAX Bot

Полная документация API: http://localhost:8000/docs

## Функционал интерфейса

### Дизайн согласно макету
- Хедер с кнопкой "цифровой пропуск", названием вуза, ролью и аватаром
- Виджеты вместо простых кнопок (календарь для расписания, карусель для новостей)
- Навигационное меню внизу для переключения между разделами
- Адаптивный дизайн

### Цифровой пропуск
- QR-код с данными пользователя
- Автоматическое обновление каждую минуту
- Таймер обратного отсчета
- Инструкции по использованию

### Чат-бот MAX

- Выбор роли через inline кнопки
- Главное меню с быстрыми действиями для каждой роли
- Открытие мини-приложения с передачей роли через параметры
- Команды: /start, /help, /profile, /schedule, /assignments, /events, /services

### Виджеты

Вместо простых кнопок-ссылок реализованы полноценные виджеты:
- Расписание - календарь с занятиями на текущий день
- Новости - карусель с автоматической сменой
- Услуги - сетка иконок с действиями
- Курсы - список с прогресс-баром
- События - список с датами
- Оплата - баланс и кнопка оплаты
- Поступление - информация для абитуриентов
- Аналитика - статистика в виде карточек

## База данных

Проект использует SQLite базы данных. Файлы .db создаются автоматически в папке data/:

### users.db
- users - пользователи с полями invitation_code_id, can_change_role
- superadmins - суперадмины приложения

### universities.db
- universities - университеты с полями admin_user_id, created_by_superadmin_id
- invitation_codes - коды приглашения с привязкой к университету и роли

### config.db
- sections - разделы для каждой роли с order_index, header_color
- blocks - блоки в разделах с order_index, config
- templates - шаблоны конфигураций
- custom_blocks - кастомные виджеты с полями code, status, review_notes

База данных инициализируется автоматически при первом запуске бэкенда. Также создается тестовый суперадмин с ID: 1.

## Конфигурация

### Ссылки на мини-приложение
Все URL обновлены для пользователя cyxar4uk:
```
https://cyxar4uk.github.io/max-university/
```

Если ваш GitHub username другой, замените cyxar4uk в файле main.py.

## Безопасность

Важно для продакшена:
1. Измените SECRET_KEY в main.py на уникальный ключ
2. Укажите конкретные домены в CORS настройках
3. Используйте переменные окружения для секретных данных
4. Настройте HTTPS для работы с MAX Bridge (GitHub Pages предоставляет HTTPS)
5. Регулярно делайте резервные копии файлов .db из папки data/
6. Проверяйте кастомные блоки перед одобрением (защита от XSS)

## Документация

- MAX Bridge API: https://dev.max.ru/docs/webapps/introduction
- MAX Bot API: https://dev.max.ru/docs/chatbots/bots-coding/library/js
- MAX UI: https://dev.max.ru/ui
- FastAPI: https://fastapi.tiangolo.com/
- React: https://react.dev/
- Vite: https://vitejs.dev/

## Troubleshooting

### Белый экран на GitHub Pages
- Проверьте консоль браузера (F12)
- Убедитесь, что base path в vite.config.js установлен правильно (/max-university/)
- Проверьте, что используется HashRouter вместо BrowserRouter
- Очистите кеш браузера (Ctrl+Shift+Delete)

### API недоступен
- Убедитесь, что бэкенд запущен на http://localhost:8000
- Проверьте CORS настройки
- Приложение работает с fallback мок-данными при недоступности API

### База данных не создается
- Убедитесь, что папка data/ доступна для записи
- Проверьте права доступа к файлам
- Запустите бэкенд хотя бы один раз для инициализации БД

### Переключатель пользователей не работает
- Откройте консоль браузера (F12)
- Проверьте localStorage (вкладка Application > Local Storage)
- Очистите localStorage и перезагрузите страницу

### Ошибки при запуске
- Проверьте версии Node.js и Python
- Удалите папки node_modules и venv, установите зависимости заново
- Проверьте, что порты 3000 и 8000 свободны

## Особенности реализации

### Интерфейс по макету
- Хедер с кнопкой "цифровой пропуск", названием вуза, ролью и аватаром
- Виджеты вместо простых блоков
- Карусель для новостей с автопрокруткой
- Навигационное меню внизу страницы

### Админ-панель
- Создание и редактирование разделов
- Drag & drop для изменения порядка разделов и блоков
- Добавление/удаление блоков в разделах
- Настройка цвета хедера для каждой роли
- Выбор активного раздела для редактирования
- Система кодов приглашения с генерацией и импортом
- Отправка кастомных виджетов на модерацию

### База данных
- SQLite базы данных в файлах .db
- Автоматическая инициализация при первом запуске
- Поддержка разделов и блоков с drag & drop
- Система шаблонов
- Коды приглашения с отслеживанием использования
- Кастомные блоки с модерацией

### Мок-режим
- Автоматическое переключение на мок-данные при недоступности бэкенда
- Уведомление пользователя о работе в демо-режиме
- Скачивание логов ошибок для отладки
- Полная функциональность в браузере без бэкенда

## Команда

Проект разработан для трека "Цифровизация: создание цифрового вуза" в рамках хакатона MAX.

Контакты:
- MAX Bot: @t280_hakaton_bot
- GitHub: https://github.com/cyxar4uk/max-university

---

Примечание: Приложение полностью функционально в режиме демонстрации без подключения к MAX. Для работы внутри MAX необходимо получить подтверждение токена и настроить мини-приложение в личном кабинете MAX для партнёров, указав URL: https://cyxar4uk.github.io/max-university/

GitHub Pages: Фронтенд работает на GitHub Pages с мок-данными. Для полноценной работы с бэкендом и базой данных нужно развернуть бэкенд на отдельном хостинге.
