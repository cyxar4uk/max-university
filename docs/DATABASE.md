# База данных: хранение на сервере (PostgreSQL)

Чтобы настройки пользователей и данные не сбрасывались при каждом деплое, базу данных нужно хранить на сервере. Рекомендуется использовать **PostgreSQL**.

## Зачем переходить на PostgreSQL

- **SQLite** (текущий вариант по умолчанию) хранит данные в файлах в каталоге `data/`. При новом деплое или пересборке контейнера эти файлы могут быть потеряны, если том не примонтирован.
- **PostgreSQL** работает как отдельный сервис: данные живут на сервере и не зависят от кода приложения. При пуше обновляется только код, БД сохраняется.

## Рекомендуемая схема

1. **На сервере** поднять PostgreSQL (отдельный контейнер или хостинг БД).
2. **В бэкенде MAX** задать переменную окружения `DATABASE_URL` в формате:
   ```text
   postgresql://user:password@host:5432/dbname
   ```
3. **Миграция**: при первом подключении к PostgreSQL нужно создать те же таблицы, что и в SQLite (users, universities, config, invitation_codes, event_registrations и т.д.). Структура описана в [backend/database.py](backend/database.py).

## Текущее состояние

Сейчас бэкенд использует **SQLite** ([backend/database.py](backend/database.py)). Поддержка PostgreSQL может быть добавлена так:

- Если задан `DATABASE_URL` — подключаться к PostgreSQL (через `psycopg2` или `asyncpg`) и использовать те же запросы с учётом отличий SQL (например, `SERIAL` вместо `AUTOINCREMENT`, `RETURNING` и т.д.).
- Если `DATABASE_URL` не задан — оставить поведение по умолчанию (SQLite) для локальной разработки.

Так пользователи и настройки (роль, university_id, коды приглашений, регистрации на мероприятия) будут сохраняться на сервере и не будут теряться при пуше.

## Документация MAX и хранение данных

По [документации MAX Bridge](https://dev.max.ru/docs/webapps/bridge) мини-приложение получает пользователя из `initDataUnsafe.user` (id, first_name, last_name и т.д.). Эти данные приходят при каждом запуске. Чтобы не терять настройки (роль, университет, виджеты), их нужно хранить на **нашем бэкенде** (в БД), привязывая к `user.id` из MAX. Текущая схема (users с max_user_id, role, university_id) уже это учитывает; важно только хранить БД на сервере (PostgreSQL), а не в репозитории.
