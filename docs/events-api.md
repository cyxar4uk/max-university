# Public Events API — подключение к MAX

В MAX мероприятия отображаются в виджетах на **Главной** и во вкладке **Хаб**. Данные берутся из вашего публичного API ивентов через прокси на бэкенде MAX.

---

## Как подключить API в MAX

### 1. Укажите URL вашего API на бэкенде MAX

На сервере, где запущен бэкенд MAX (FastAPI), задайте переменную окружения:

```bash
EVENTS_API_URL=https://<ваш-домен-сервиса-ивентов>/api/public
```

**Важно:** указывайте **базовый URL без пути `/events`** — MAX сам добавляет `/events` при запросе.

**Примеры:**

- Локально: `EVENTS_API_URL=http://localhost:8000/api/public`
- Продакшен: `EVENTS_API_URL=https://events.example.com/api/public`

### 2. (Опционально) Ссылка на бота

По умолчанию используется бот [События РАНХиГС](https://t.me/event_ranepa_bot). Чтобы переопределить:

```bash
EVENTS_BOT_LINK=https://t.me/your_events_bot
```

Если ваш API в ответе отдаёт поле `bot_link`, MAX использует его; иначе — значение `EVENTS_BOT_LINK`.

### 3. Перезапустите бэкенд MAX

После установки переменных перезапустите процесс (systemd, Docker и т.п.), чтобы они подхватились.

### 4. Проверка

- Откройте приложение MAX → вкладка **Хаб**.
- Блок **«Ближайшие события»** должен показывать мероприятия из вашего API.
- Если `EVENTS_API_URL` не задан или API недоступен, отображается заглушка «Пока нет мероприятий» и ссылка «Открыть в боте».

---

## Контракт Public Events API (ваш сервис)

MAX вызывает ваш API так:

- **Метод:** `GET {EVENTS_API_URL}/events`
- **Параметры:** `limit` (int, по умолчанию 10, макс. 50)

**Пример запроса от MAX:**

```
GET https://<ваш-домен>/api/public/events?limit=10
```

### Ожидаемый формат ответа (JSON)

```json
{
  "events": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "Карьерный форум",
      "name": "Карьерный форум",
      "date": "2026-03-01T09:00:00+00:00",
      "location": "ПРЕЗИДЕНТСКАЯ АКАДЕМИЯ",
      "registration_status": "open",
      "bot_link": "https://t.me/event_ranepa_bot?start=event_550e8400-e29b-41d4-a716-446655440000"
    }
  ],
  "bot_link": "https://t.me/event_ranepa_bot"
}
```

### Поля карточки мероприятия

| Поле                | Тип    | Описание                                                                 |
|---------------------|--------|--------------------------------------------------------------------------|
| id                  | string | UUID мероприятия                                                          |
| title               | string | Название мероприятия                                                     |
| name                | string | Alias для title (совместимость с MAX)                                    |
| date                | string | Дата начала в формате ISO 8601                                            |
| location             | string | Место проведения                                                         |
| registration_status | string | `open` — регистрация открыта, `closed` — закрыта                         |
| bot_link            | string | (Опционально) Deep link в бота на это мероприятие (кнопка «Записаться»)  |

Если у мероприятия есть **bot_link**, в MAX по кнопке «Записаться» пользователь перейдёт именно на это мероприятие в боте (формат: `https://t.me/event_ranepa_bot?start=event_{event_id}`).

### Авторизация

Не требуется. API публичный, запросы идут backend-to-backend от MAX к вашему сервису.

---

## Переменные окружения (MAX)

| Переменная      | Описание                                                                 |
|-----------------|---------------------------------------------------------------------------|
| EVENTS_API_URL  | Базовый URL API (например `https://.../api/public`). Если пусто — виджет показывает заглушку. |
| EVENTS_BOT_LINK | Ссылка на бота по умолчанию (переопределяет значение из ответа API при отсутствии там `bot_link`). |

---

## Секреты GitHub (деплой на VPS)

Если деплой идёт через **GitHub Actions** на VPS (workflow `deploy-vps.yml`), можно задать URL API мероприятий в **секретах репозитория** — они будут записываться на сервер при каждом деплое.

1. В репозитории: **Settings → Secrets and variables → Actions**.
2. Нажмите **New repository secret**.
3. Добавьте секреты:
   - **EVENTS_API_URL** — базовый URL вашего Public Events API, например `https://ваш-домен-ивентов.ru/api/public`.
   - **EVENTS_BOT_LINK** (опционально) — ссылка на бота, например `https://t.me/event_ranepa_bot`.

При деплое workflow записывает их в файл `backend/.env.events` на сервере. Бэкенд должен читать этот файл при старте (в systemd-юните указан `EnvironmentFile=/path/to/repo/backend/.env.events` — см. `deploy/max-university-backend.service`). Если юнит настраивали вручную, добавьте строку:

```ini
EnvironmentFile=/path/to/repo/backend/.env.events
```

и перезагрузите unit: `sudo systemctl daemon-reload && sudo systemctl restart max-university-backend`.

**Важно:** файл `.env.events` создаётся только если секрет **EVENTS_API_URL** в GitHub задан. Если секрет не задан, файл не перезаписывается (старые значения на сервере сохраняются).

---

## Где в MAX показываются мероприятия

- **Хаб** — блок «Ближайшие события» (карточка первого мероприятия + кнопка «Записаться», при отсутствии данных — «Пока нет мероприятий»).
- При необходимости тот же виджет можно вывести на Главную (интеграция уже есть, данные те же).

Если что-то не работает, проверьте: доступность вашего API с сервера MAX (`curl "$EVENTS_API_URL/events?limit=5"`), формат ответа и переменные окружения.
